diff -r 6dd03ceea326 -r 44e6d0be2feb lib-python/3/ctypes/macholib/dyld.py
--- a/lib-python/3/ctypes/macholib/dyld.py	Wed Jan 13 07:42:50 2021 +0200
+++ b/lib-python/3/ctypes/macholib/dyld.py	Fri Jan 15 19:01:29 2021 -0800
@@ -6,6 +6,11 @@
 from ctypes.macholib.framework import framework_info
 from ctypes.macholib.dylib import dylib_info
 from itertools import *
+try:
+    from _ctypes import _dyld_shared_cache_contains_path
+except ImportError:
+    def _dyld_shared_cache_contains_path(*args):
+        raise NotImplementedError
 
 __all__ = [
     'dyld_find', 'framework_find',
@@ -122,8 +127,15 @@
                 dyld_executable_path_search(name, executable_path),
                 dyld_default_search(name, env),
             ), env):
+
         if os.path.isfile(path):
             return path
+        try:
+            if _dyld_shared_cache_contains_path(path):
+                return path
+        except NotImplementedError:
+            pass
+
     raise ValueError("dylib %s could not be found" % (name,))
 
 def framework_find(fn, executable_path=None, env=None):
diff -r 6dd03ceea326 -r 44e6d0be2feb lib-python/3/ctypes/test/test_macholib.py
--- a/lib-python/3/ctypes/test/test_macholib.py	Wed Jan 13 07:42:50 2021 +0200
+++ b/lib-python/3/ctypes/test/test_macholib.py	Fri Jan 15 19:01:29 2021 -0800
@@ -45,19 +45,22 @@
 class MachOTest(unittest.TestCase):
     @unittest.skipUnless(sys.platform == "darwin", 'OSX-specific test')
     def test_find(self):
-
-        self.assertEqual(find_lib('pthread'),
-                             '/usr/lib/libSystem.B.dylib')
+        # On Mac OS 11, system dylibs are only present in the shared cache,
+        # so symlinks like libpthread.dylib -> libSystem.B.dylib will not
+        # be resolved by dyld_find
+        self.assertIn(find_lib('pthread'),
+                              ('/usr/lib/libSystem.B.dylib', '/usr/lib/libpthread.dylib'))
 
         result = find_lib('z')
         # Issue #21093: dyld default search path includes $HOME/lib and
         # /usr/local/lib before /usr/lib, which caused test failures if
         # a local copy of libz exists in one of them. Now ignore the head
         # of the path.
-        self.assertRegex(result, r".*/lib/libz\..*.*\.dylib")
+        self.assertRegex(result, r".*/lib/libz.*\.dylib")
 
-        self.assertEqual(find_lib('IOKit'),
-                             '/System/Library/Frameworks/IOKit.framework/Versions/A/IOKit')
+        self.assertIn(find_lib('IOKit'),
+                              ('/System/Library/Frameworks/IOKit.framework/Versions/A/IOKit',
+                              '/System/Library/Frameworks/IOKit.framework/IOKit'))
 
 if __name__ == "__main__":
     unittest.main()
diff -r 6dd03ceea326 -r 44e6d0be2feb lib_pypy/_ctypes/__init__.py
--- a/lib_pypy/_ctypes/__init__.py	Wed Jan 13 07:42:50 2021 +0200
+++ b/lib_pypy/_ctypes/__init__.py	Fri Jan 15 19:01:29 2021 -0800
@@ -13,15 +13,15 @@
     _string_at_addr, _wstring_at_addr, set_conversion_mode)
 from _ctypes.union import Union
 
+try: from __pypy__ import builtinify
+except ImportError: builtinify = lambda f: f
+
 import os as _os
 
 if _os.name in ("nt", "ce"):
     from _rawffi import FormatError
     from _rawffi import check_HRESULT as _check_HRESULT
 
-    try: from __pypy__ import builtinify
-    except ImportError: builtinify = lambda f: f
-
     @builtinify
     def CopyComPointer(src, dst):
         from ctypes import c_void_p, cast
@@ -32,8 +32,6 @@
         dst[0] = cast(src, c_void_p).value
         return 0
 
-    del builtinify
-
     LoadLibrary = dlopen
 
 from _rawffi import FUNCFLAG_STDCALL, FUNCFLAG_CDECL, FUNCFLAG_PYTHONAPI
@@ -43,6 +41,19 @@
 if _os.name in ("nt", "ce"):
     from _ctypes.builtin import get_last_error, set_last_error
 
+import sys as _sys
+if _sys.platform == 'darwin':
+    try:
+        from ._ctypes_cffi import lib as _lib
+        if hasattr(_lib, 'dyld_shared_cache_contains_path'):
+            @builtinify
+            def _dyld_shared_cache_contains_path(path):
+                return _lib.dyld_shared_cache_contains_path(path.encode())
+    except ImportError:
+        pass
+
+del builtinify
+
 __version__ = '1.1.0'
 #XXX platform dependant?
 RTLD_LOCAL = 0
diff -r 6dd03ceea326 -r 44e6d0be2feb lib_pypy/_ctypes/_ctypes_build.py
--- /dev/null	Thu Jan 01 00:00:00 1970 +0000
+++ b/lib_pypy/_ctypes/_ctypes_build.py	Fri Jan 15 19:01:29 2021 -0800
@@ -0,0 +1,22 @@
+import os
+
+from cffi import FFI
+
+ffi = FFI()
+ffi.cdef('bool dyld_shared_cache_contains_path(const char* path);')
+ffi.set_source('_ctypes_cffi', r'''
+#include <stdbool.h>
+#include <mach-o/dyld.h>
+
+bool _dyld_shared_cache_contains_path(const char* path) __attribute__((weak_import));
+bool dyld_shared_cache_contains_path(const char* path) {
+    if (_dyld_shared_cache_contains_path == NULL) {
+        return false;
+    }
+    return _dyld_shared_cache_contains_path(path);
+}
+''')
+
+if __name__ == '__main__':
+    os.chdir(os.path.dirname(__file__))
+    ffi.compile()
diff -r 6dd03ceea326 -r 44e6d0be2feb lib_pypy/pypy_tools/build_cffi_imports.py
--- a/lib_pypy/pypy_tools/build_cffi_imports.py	Wed Jan 13 07:42:50 2021 +0200
+++ b/lib_pypy/pypy_tools/build_cffi_imports.py	Fri Jan 15 19:01:29 2021 -0800
@@ -1,5 +1,5 @@
 from __future__ import print_function
-import sys, shutil, os, tempfile, hashlib
+import sys, shutil, os, tempfile, hashlib, collections
 import sysconfig
 from os.path import join
 
@@ -22,22 +22,24 @@
     pass
 
 
-cffi_build_scripts = {
-    "_blake2": "_blake2/_blake2_build.py",
-    "_ssl": "_ssl_build.py",
-    "sqlite3": "_sqlite3_build.py",
-    "audioop": "_audioop_build.py",
-    "_tkinter": "_tkinter/tklib_build.py",
-    "curses": "_curses_build.py" if sys.platform != "win32" else None,
-    "syslog": "_syslog_build.py" if sys.platform != "win32" else None,
-    "_gdbm": "_gdbm_build.py"  if sys.platform != "win32" else None,
-    "grp": "_pwdgrp_build.py" if sys.platform != "win32" else None,
-    "resource": "_resource_build.py" if sys.platform != "win32" else None,
-    "lzma": "_lzma_build.py",
-    # "_decimal": "_decimal_build.py",
-    "_sha3": "_sha3/_sha3_build.py",
-    "xx": None,    # for testing: 'None' should be completely ignored
-    }
+cffi_build_scripts = collections.OrderedDict([
+    ("_ctypes._ctypes_cffi",
+     "_ctypes/_ctypes_build.py" if sys.platform == 'darwin' else None),
+    ("_blake2", "_blake2/_blake2_build.py"),
+    ("_ssl", "_ssl_build.py"),
+    ("sqlite3", "_sqlite3_build.py"),
+    ("audioop", "_audioop_build.py"),
+    ("_tkinter", "_tkinter/tklib_build.py"),
+    ("curses", "_curses_build.py" if sys.platform != "win32" else None),
+    ("syslog", "_syslog_build.py" if sys.platform != "win32" else None),
+    ("_gdbm", "_gdbm_build.py"  if sys.platform != "win32" else None),
+    ("grp", "_pwdgrp_build.py" if sys.platform != "win32" else None),
+    ("resource", "_resource_build.py" if sys.platform != "win32" else None),
+    ("lzma", "_lzma_build.py"),
+    # ("_decimal", "_decimal_build.py"),
+    ("_sha3", "_sha3/_sha3_build.py"),
+    ("xx", None),    # for testing: 'None' should be completely ignored
+    ])
 
 # for distribution, we may want to fetch dependencies not provided by
 # the OS, such as a recent openssl/libressl.

